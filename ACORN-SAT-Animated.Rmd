---
title: "Animated visualisatios of 100 years of Australian temperature data via the ACORN-SAT dataset"
author: "Tom Perkins"
date: "19/02/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# The Data

In a [previous analysis](https://perkot.github.io/ACORN-SAT-Climate-Data/), I explored publicly available data from the [Bureau of Meteorology](http://www.bom.gov.au/climate/data/acorn-sat/#tabs=ACORN%E2%80%90SAT) to examine change in Australian temperatures over the past 100 years. In this page we will utilize the power off ggplot2 to visualise the data

Let's load our dependencies 

```{r Load dependencies, results='hide', message=FALSE, warning=FALSE}
require(tidyverse)
require(readr)
require(ggplot2)
require(gganimate)
require(viridis)
require(scales)
require(gifski)
require(png)
require(transformr)
require(kableExtra)
```

& read-in the pre-cleaned temperature data from the previous kernel 

```{r function to data, results='hide', message=FALSE, warning=FALSE}
tbl <- read.csv("/Users/perkot/GIT/data/ACORN-SAT-Clean.csv")
```

```{r print table preview, echo=FALSE}
# Print table 
tbl %>% 
  select(site.name , 
         date, 
         minimum.temperature..degC., 
         maximum.temperature..degC., 
         Year) %>%
  top_n(20) %>% 
  kable() %>% #head limits to just top rows
  kable_styling(bootstrap_options = c("striped", 
                                      "hover", 
                                      "condensed", 
                                      "responsive", 
                                      font_size = 8))
```

If using a mac, you may encounter some teething issues rendering visualizations with gganimate. [This resource](https://www.youtube.com/watch?v=VfLRhPEuYDc) provides a guide of steps to troubleshoot in terminal. Otherwise, we should be good-to-go.

# Monthly avg maximum temperatures

## Animated by year 

In the below step, I create customer colour palettes to give full manual control of which colours are assigned to which element in the visualisation (in the below example, state of Australia)

```{r colour themes}
# color themes 
state.colors.gradient.2 <- 
  c("NT" = "#993B37", 
    "TAS" = "#7AA2BE", 
    "VIC" = "#4EA599",  
    "SA" = "#E1A345", 
    "NSW" = "#D2AF47", 
    "WA" = "#C88370", 
    "QLD" = "#CA6A33") 

state.colors.gradient.3 <- 
  c("NT" = "#993B37", 
    "TAS" = "#7AA2BE", 
    "VIC" = "#4ea58e",  
    "SA" = "#e3963d", 
    "NSW" = "#D2AF47", 
    "WA" = "#d97529", 
    "QLD" = "#c95042") 
```

To avoid repetition in our code, we can pre-save some of the custom theme elements to call in each visualisation (i.e. font sizes, font colours, legend formatting)

```{r plot themes}
# Themes for plot visualisations 
theme_plot <-
  theme(
    plot.title = element_text(size = 14, hjust = 0, colour = "#4E4F4E", face = "bold"),
    plot.subtitle = element_text(size = 12, hjust = 0, colour = "#4E4F4E"),
    axis.title = element_text(size = 12, colour = "#4E4F4E"),
    legend.title = element_text(size = 12, colour = "#4E4F4E"),
    axis.text = element_text(size = 12, colour = "#4E4F4E"),
    panel.background = element_rect(fill = "#fcf9f0",
                                    colour = "#fcf9f0"),
    plot.background = element_rect(fill = "#fcf9f0",
                                   colour = "#fcf9f0"))

theme_plot_2 <-
  theme(
    plot.title = element_text(size = 12, hjust = 0, colour = "#4E4F4E", face = "bold"),
    plot.subtitle = element_text(size = 10, hjust = 0, colour = "#4E4F4E"),
    axis.title = element_text(size = 9, colour = "#4E4F4E"),
    legend.title = element_text(size = 10, hjust = 0.5, colour = "#4E4F4E"),
    axis.text = element_text(size = 9, colour = "#4E4F4E"),
    panel.background = element_rect(fill = "#fcf9f0",
                                    colour = "#fcf9f0"),
    plot.background = element_rect(fill = "#fcf9f0",
                                   colour = "#fcf9f0"))
```

For the first visualization, the average maximum temperature will be visualized for each state of Australia. This will be animated over each decade from 1900 up to 2010 

As such the first required step is to group the dataframe by both state and decade, summarizing by the mean maximum temperature

```{r variable clean}
# Create table
temp.max3C <- tbl %>% 
  group_by(State, Era) %>% 
  filter(Era != 2019) %>% 
  summarise(avgmax = mean(maximum.temperature..degC., na.rm = TRUE))

# as character
temp.max3C$Era <- as.character(temp.max3C$Era)
# remove s
temp.max3C$Era = substr(temp.max3C$Era,1,nchar(temp.max3C$Era)-1)
# to numeric
temp.max3C$Era <- as.numeric(temp.max3C$Era)
```

### All Seasons

create plot

```{r create plot}
# PLOT
state.plot.2 <- 
  ggplot(temp.max3C, aes(Era, avgmax, group = State, color = State)) + 
  geom_line(size = 1.6) + 
  geom_segment(aes(xend = 2018, yend = avgmax), linetype = 2, colour = 'grey') + 
  geom_point(size = 8) + 
  geom_text(aes(x = 2018, label = State, size = 16), hjust = 0) + 
  scale_colour_manual(values = state.colors.gradient.2) +
  coord_cartesian(clip = 'off') + 
  labs(title = 'Average daily-maximum temperature in Australia over the past 100 years',
       subtitle = 'Separated by State',
       caption  = "Data Source: ACORN-SAT",
       y = 'Temperature (°C)',
       X = "Year") +
  theme_minimal() + 
  theme(legend.position = "none") +
  theme(plot.margin = margin(5.5, 40, 5.5, 5.5)) + 
  theme_plot +
  transition_reveal(Era) 
```

Animate plot

```{r animate plot}
# ANIMATE PLOT
state.plot.2.anim <-
animate(state.plot.2,
        end_pause = 80,
        fps = 30,
        nframe = 240,
        height = 1024,
        width = 768)
```

```{r save plot, results='hide', message=FALSE, warning=FALSE, echo=FALSE}
# SAVE PLOT 
anim_save("state.plot.2.anim.gif",
          state.plot.2.anim,
          width = 4000, 
          height = 4000)
```

Show

![Show](state.plot.2.anim.gif)


# Plot [1]

## Monthly average-maximum temperatures, animated by year

In one piece of code, lets aggregate the data & create our plot

```{r month plot, results='hide', message=FALSE, warning=FALSE}
# Minimalistic theme for visualisation 
theme_plot_text <-
  theme(
    plot.title = element_text(size = 10, hjust = 0.5),
    axis.title = element_text(size = 10),
    legend.title = element_text(size = 10),
    axis.text = element_text(size = 7))

# plot
month.plot <- tbl %>% 
  group_by(Month, Year) %>% 
  filter(Year != 2019) %>% 
  summarise(avgmax = mean(maximum.temperature..degC., na.rm = TRUE)) %>% 
  ggplot(aes(x = Month, 
             y = avgmax,
             group = Year,
             colour = avgmax)) +
  geom_point() +
  geom_line() +
  scale_colour_gradient2(low = "#E1B823", mid = "#DD8033" , high = "#a4111e",
                         midpoint = 25) +
  labs(title = 'Average daily-maximum temperature in Australia over the past 100 years',
       subtitle = 'Separated by month',
       caption  = "Data Source: ACORN-SAT",
       y = 'Temperature (°C)',
       x = "Year") +
  theme_bw() +
  theme(panel.border = element_blank(),
        axis.line = element_line(colour = "black", size = 0.2),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        plot.title = element_text(size = 6, hjust = 0.5),
        legend.text = element_text(size = 6)) +
  theme_plot_text +
  labs(color = '°C', size = 6) 
```

To animate this plot, we will use "transition states" from package gganimate. This function attributes values of a dimension (in this case, year) to an individual frame. We can then tweak parameters of the animation (length of transitions, whether the plot animation loops, etc)

```{r month plot animate, results='hide', message=FALSE, warning=FALSE}
month.plot <- month.plot + 
  transition_states(states = Year,
                    transition_length = 3, # relative length of transistion
                    state_length = 1, # relative length of pause at the states
                    wrap = TRUE) + # loops the animation
labs(subtitle  = 'Year: {closest_state}') + # includes dynamic sub-title
shadow_mark()
```

Finally we can animate & view the plot, setting parameters such as framers per second, total frames in the animation, & number of frames comprising the end pause

```{r month plot animate two, echo=FALSE, message=FALSE, warning=FALSE}
# Animate Plot
animate(month.plot, 
        end_pause = 40,
        fps = 30,
        nframe = 400) 
```

Following this formula, lets create two further plots

I have taken inspiration from an approach to animated time-series plots by one of R's gurus [Thomas Lin Pedersen](https://github.com/thomasp85/gganimate/wiki/Temperature-time-series)

The first of these plots will look at temperature change by month of the year, whilst the second plot will examine by region of Australia

# Plot [2]

## Time-series of average max temperature, animated by month

Let's prep the data for plotting 

```{r month era data prep, results='hide', message=FALSE, warning=FALSE}
# Create table
temp.max3 <- tbl %>% 
  group_by(Month, Era) %>% 
  filter(Era != 2019) %>% 
  summarise(avgmax = mean(maximum.temperature..degC., na.rm = TRUE))
```

```{r month convert}
# Convert numeric months to text 
temp.max3$Month[temp.max3$Month=="1"] <- "January"
temp.max3$Month[temp.max3$Month=="2"] <- "February"
temp.max3$Month[temp.max3$Month=="3"] <- "March"
temp.max3$Month[temp.max3$Month=="4"] <- "April"
temp.max3$Month[temp.max3$Month=="5"] <- "May"
temp.max3$Month[temp.max3$Month=="6"] <- "June"
temp.max3$Month[temp.max3$Month=="7"] <- "July"
temp.max3$Month[temp.max3$Month=="8"] <- "August"
temp.max3$Month[temp.max3$Month=="9"] <- "September"
temp.max3$Month[temp.max3$Month=="10"] <- "October"
temp.max3$Month[temp.max3$Month=="11"] <- "November"
temp.max3$Month[temp.max3$Month=="12"] <- "December"

```

```{r conversions}
# as character
temp.max3$Era <- as.character(temp.max3$Era)
# remove s
temp.max3$Era = substr(temp.max3$Era,1,nchar(temp.max3$Era)-1)
# to numeric
temp.max3$Era <- as.numeric(temp.max3$Era)
```

& create a custom colour palette for the plot 

```{r month era data prep two, results='hide', message=FALSE, warning=FALSE}
group.colors.gradient <- c("January" = "#ab1312",
                           "February" = "#b01e13", 
                           "March" = "#b83616", 
                           "April" = "#ca6c1b", 
                           "May" = "#d4891e", 
                           "June" = "#dda821", 
                           "July" = "#e1b823", 
                           "August" = "#d89820",  
                           "September" = "#cf7a1d", 
                           "October" = "#c65e1a", 
                           "November" = "#bd4317", 
                           "December" = "#b42a14") 
```

Create our month plot 

```{r month era plot animate, results='hide', message=FALSE, warning=FALSE}
month.plot <- 
  ggplot(temp.max3, aes(Era, avgmax, group = Month, color = Month)) + 
  geom_line() + 
  geom_segment(aes(xend = 2018, yend = avgmax), linetype = 2, colour = 'grey') + 
  geom_point(size = 2) + 
  geom_text(aes(x = 2018, label = Month), hjust = 0) + 
  scale_colour_manual(values = group.colors.gradient) +
  transition_reveal(Era) + 
  coord_cartesian(clip = 'off') + 
  labs(title = 'Average daily-maximum temperature in Australia over the past 100 years',
       subtitle = 'Separated by month',
       caption  = "Data Source: ACORN-SAT",
       y = 'Temperature (°C)',
       x = "Year") +
  theme_minimal() + 
  theme(legend.position = "none") +
  theme(plot.margin = margin(5.5, 40, 5.5, 5.5)) 
```

```{r month era plot animate two, echo=FALSE, message=FALSE, warning=FALSE}
animate(month.plot, 
        end_pause = 40,
        fps = 30,
        nframe = 200) 
```

# Plot [3]

## Time-series of average max temperature, animated by state

Let's prep the data for plotting 

```{r state data prep, results='hide', message=FALSE, warning=FALSE}
# Create table
temp.max3C <- tbl %>% 
  group_by(State, Era) %>% 
  filter(Era != 2019) %>% 
  summarise(avgmax = mean(maximum.temperature..degC., na.rm = TRUE))

# as character
temp.max3C$Era <- as.character(temp.max3C$Era)
# remove s
temp.max3C$Era = substr(temp.max3C$Era,1,nchar(temp.max3C$Era)-1)
# to numeric
temp.max3C$Era <- as.numeric(temp.max3C$Era)
```

& create a custom colour palette for the plot 

```{r state data prep two, results='hide', message=FALSE, warning=FALSE}
state.colors.gradient <- 
  c("NT" = "#ab1312", 
    "TAS" = "#e1b823", 
    "VIC" = "#d89820",  
    "SA" = "#cf7a1d", 
    "NSW" = "#c65e1a", 
    "WA" = "#bd4317", 
    "QLD" = "#b42a14") 
```

Create our state plot 

```{r state plot animate, results='hide', message=FALSE, warning=FALSE}
state.plot <- 
  ggplot(temp.max3C, aes(Era, avgmax, group = State, color = State)) + 
  geom_line() + 
  geom_segment(aes(xend = 2018, yend = avgmax), linetype = 2, colour = 'grey') + 
  geom_point(size = 2) + 
  geom_text(aes(x = 2018, label = State), hjust = 0) + 
  scale_colour_manual(values = state.colors.gradient) +
  coord_cartesian(clip = 'off') + 
  labs(title = 'Average daily-maximum temperature in Australia over the past 100 years',
       subtitle = 'Separated by State',
       caption  = "Data Source: ACORN-SAT",
       y = 'Temperature (°C)',
       X = "Year") +
  theme_minimal() + 
  theme(legend.position = "none") +
  theme(plot.margin = margin(5.5, 40, 5.5, 5.5)) +
  transition_reveal(Era) 
```

```{r state plot animate two, echo=FALSE, message=FALSE, warning=FALSE}
animate(state.plot, 
        end_pause = 40,
        fps = 30,
        nframe = 200)
```
